@inject Microsoft.AspNetCore.Identity.UserManager<CoffeeShopSimulation.Models.LoyaltyUser> UserManager
@using System.Security.Claims

@{
    // navigation menu
    var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    var isLoggedIn = !string.IsNullOrEmpty(userId);
    int points = 0;
    bool canRedeemSmall = false;
    bool canRedeemMedium = false;
    bool canRedeemLarge = false;
    bool canRedeemAny = false;
    bool isBirthday = false;
    bool hasBirthdayNotification = false;
    
    if (isLoggedIn)
    {
        var user = await UserManager.FindByIdAsync(userId);
        if (user != null)
        {
            points = user.LoyaltyPoints;
            canRedeemSmall = user.CanRedeemReward("small");
            canRedeemMedium = user.CanRedeemReward("medium");
            canRedeemLarge = user.CanRedeemReward("large");
            canRedeemAny = canRedeemSmall || canRedeemMedium || canRedeemLarge;
            
            // Check for birthday notification
            isBirthday = user.IsBirthdayToday() && !user.HasUsedBirthdayDiscountToday();
            hasBirthdayNotification = isBirthday;
        }
    }
    
    // Show notification if can redeem OR if it's birthday
    bool showNotification = canRedeemAny || hasBirthdayNotification;
}

<div class="nav-menu-container" id="navMenuContainer" style="display: none;">
    <div class="nav-menu-overlay" onclick="toggleNavMenu()"></div>
    <div class="nav-menu">
        <button class="nav-menu-close" onclick="toggleNavMenu()">‚úï</button>
        <h2 class="nav-menu-title">Menu</h2>
        
        <a asp-controller="Home" asp-action="Index" class="nav-menu-item">
            ‚òï Order Drink
        </a> 
        
        @if (isLoggedIn)
        {
            <a asp-controller="Home" asp-action="OrderHistory" class="nav-menu-item">
                üìã Order History
            </a>
            <a asp-controller="Home" asp-action="Rewards" class="nav-menu-item @(showNotification ? "has-notification" : "")">
                ‚≠ê Rewards (@points pts)
                @if (showNotification)
                {
                    <span class="notification-dot"></span>
                }
            </a>
        }
        
        <a asp-controller="Home" asp-action="Landing" class="nav-menu-item">
            üè† Home
        </a>
        
        @if (isLoggedIn)
        {
            <form asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Landing", "Home")" method="post" class="nav-menu-logout">
                <button type="submit" class="nav-menu-item nav-menu-item-logout">
                    üö™ Log Out
                </button>
            </form>
        }
        else
        {
            <a asp-area="Identity" asp-page="/Account/Login" asp-route-returnUrl="/Home/Index" class="nav-menu-item">
                üîê Log In
            </a>
        }
    </div>
</div>

<button id="nav-menu-toggle-btn" class="nav-menu-toggle @(showNotification ? "has-notification" : "")" onclick="toggleNavMenu()">
    ‚ò∞
    @if (showNotification)
    {
        <span class="notification-badge">!</span>
    }
</button>

<style>
    .nav-menu-toggle {
        position: fixed !important;
        top: 20px;
        left: 20px;
        background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 9999 !important;
        transition: all 0.3s ease;
        will-change: transform;
    }
    
    .nav-menu-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    
    .nav-menu-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2000;
    }
    
    .nav-menu-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
    }
    
    .nav-menu {
        position: absolute;
        top: 0;
        left: 0;
        width: 280px;
        height: 100%;
        background: linear-gradient(135deg, #FFE5D9, #FFCAD4);
        box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        padding: 2rem 1rem;
        overflow-y: auto;
    }
    
    .nav-menu-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: transparent;
        border: none;
        font-size: 28px;
        color: #666;
        cursor: pointer;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }
    
    .nav-menu-close:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
    }
    
    .nav-menu-title {
        font-size: 2rem;
        font-weight: 800;
        color: #FF6B6B;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .nav-menu-item {
        display: block;
        padding: 15px 20px;
        margin: 10px 0;
        background: white;
        border-radius: 15px;
        text-decoration: none;
        color: #333;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .nav-menu-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
        color: white;
    }
    
    .nav-menu-logout {
        margin-top: auto;
    }
    
    .nav-menu-item-logout {
        width: 100%;
        text-align: left;
        background: linear-gradient(135deg, #87CEEB, #98D8E8);
    }
    
    .nav-menu-item-logout:hover {
        background: linear-gradient(135deg, #6BB6FF, #87CEEB);
    }
    
    .notification-badge {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #FF6B6B;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse-badge 1.5s infinite;
    }
    
    .notification-dot {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #FF6B6B;
        border-radius: 50%;
        width: 12px;
        height: 12px;
        animation: pulse-badge 1.5s infinite;
    }
    
    .nav-menu-toggle.has-notification {
        position: relative;
    }
    
    .nav-menu-item.has-notification {
        position: relative;
    }
    
    @@keyframes pulse-badge {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
    }
</style>

<script>
    // Remove any duplicate menu buttons
    document.addEventListener('DOMContentLoaded', function() {
        const menuButtons = document.querySelectorAll('.nav-menu-toggle');
        if (menuButtons.length > 1) {
            // keep only the first one
            for (let i = 1; i < menuButtons.length; i++) {
                menuButtons[i].remove();
            }
        }
        
        const menuContainers = document.querySelectorAll('.nav-menu-container');
        if (menuContainers.length > 1) {
            // keep only the first one
            for (let i = 1; i < menuContainers.length; i++) {
                menuContainers[i].remove();
            }
        }
    });
    
    function toggleNavMenu() {
        const container = document.getElementById('navMenuContainer');
        if (container) {
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }
    }
    
    // close menu when clicking outside
    document.addEventListener('click', function(e) {
        const container = document.getElementById('navMenuContainer');
        if (container && container.style.display !== 'none') {
            if (!container.contains(e.target) && !e.target.classList.contains('nav-menu-toggle') && !e.target.closest('.nav-menu-toggle')) {
                container.style.display = 'none';
            }
        }
    });
</script>

